@* ------------------------------------------------------------
   Vue Index.cshtml
   Liste paginée/filtrable des FNC. Permet la recherche, les filtres
   de statut/type/impact/action et un bouton pour créer une nouvelle FNC.
   POST/GET via FncController.Index et Search.
   ------------------------------------------------------------ *@
@using PFE_Etudiant_Asteelflash.Models.Fnc
@model IEnumerable<FncIndexViewModel>

@{
    ViewData["Title"] = "Liste des Fiches de Non-Conformité";
    var currentStatus = ViewData["Status"] as string ?? string.Empty;
    var searchTerm = ViewData["SearchTerm"] as string ?? string.Empty;
}

<div class="container">
    <h1>@ViewData["Title"]</h1>
    
    <div class="row mb-3">
        <div class="col">
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Nouvelle FNC
            </a>
        </div>
        <div class="col-md-6">
            <form asp-action="Search" method="get" class="form-inline float-right">
                <div class="input-group w-100">
                    <input type="text" name="term" class="form-control" placeholder="Rechercher..." value="@searchTerm">
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-outline-secondary d-flex align-items-center">
                            <i class="fas fa-search mr-1"></i> Rechercher
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtrage par formulaire standard -->
    <form asp-action="Index" method="get" id="filterForm">
        <div class="row mb-3">
            <div class="col">
                <label>Statut:</label>
                <div class="btn-group" role="group">
                    <!-- Utilisation d'un radio button pour chaque statut -->
                    @if (currentStatus == "")
                    {
                        <input type="radio" name="status" id="status_all" value="" checked class="btn-check">
                    }
                    else
                    {
                        <input type="radio" name="status" id="status_all" value="" class="btn-check">
                    }
                    <label for="status_all" class="btn btn-outline-secondary">Tous</label>

                    @if (currentStatus == "ouvert")
                    {
                        <input type="radio" name="status" id="status_ouverte" value="ouvert" checked class="btn-check">
                    }
                    else
                    {
                        <input type="radio" name="status" id="status_ouverte" value="ouvert" class="btn-check">
                    }
                    <label for="status_ouverte" class="btn btn-outline-primary">Ouverte</label>

                    @if (currentStatus == "en_cours")
                    {
                        <input type="radio" name="status" id="status_encours" value="en_cours" checked class="btn-check">
                    }
                    else
                    {
                        <input type="radio" name="status" id="status_encours" value="en_cours" class="btn-check">
                    }
                    <label for="status_encours" class="btn btn-outline-warning">En cours</label>

                    @if (currentStatus == "fermé")
                    {
                        <input type="radio" name="status" id="status_cloturee" value="fermé" checked class="btn-check">
                    }
                    else
                    {
                        <input type="radio" name="status" id="status_cloturee" value="fermé" class="btn-check">
                    }
                    <label for="status_cloturee" class="btn btn-outline-success">Clôturée</label>

                    @if (currentStatus == "annulé")
                    {
                        <input type="radio" name="status" id="status_annule" value="annulé" checked class="btn-check">
                    }
                    else
                    {
                        <input type="radio" name="status" id="status_annule" value="annulé" class="btn-check">
                    }
                    <label for="status_annule" class="btn btn-outline-danger">Annulée</label>
                </div>
            </div>
        </div>

        @{ var labels = new Dictionary<string,string>{
            {"defaut","Type défaut"},
            {"typeFnc","Type FNC"},
            {"action","Action"},
            {"impact","Impact"}
        }; }

        <div class="row mb-3">
            @foreach (var filter in new[] { "defaut", "typeFnc", "action", "impact" })
            {
                var currentValue = ViewContext.HttpContext.Request.Query[filter];
                <div class="col">
                    <label>@labels[filter]:</label>
                    <select name="@filter" class="form-control" onchange="document.getElementById('filterForm').submit()">
                        <option value="">Tous</option>
                        @if (Model.FirstOrDefault()?.FilterOptions?.ContainsKey(filter) == true)
                        {
                            @foreach (var option in Model.FirstOrDefault().FilterOptions[filter])
                            {
                                var isSelected = option.Value == currentValue.ToString();
                                if (isSelected)
                                {
                                    <option selected value="@option.Value">@option.Text</option>
                                }
                                else
                                {
                                    <option value="@option.Value">@option.Text</option>
                                }
                            }
                        }
                    </select>
                </div>
            }
        </div>

        <div class="row mb-3">
            <div class="col">
                <button type="submit" class="btn btn-primary">Appliquer les filtres</button>
                <a asp-action="Index" class="btn btn-outline-secondary">Réinitialiser</a>
            </div>
        </div>
    </form>

    <!-- Affichage des messages d'état -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Référence</th>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Transmetteur</th>
                    <th>Processeur</th>
                    <th>Statut</th>
                    <th>QRQC</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var fnc in Model)
                {
                    <tr>
                        <td>@fnc.Ref</td>
                        <td>@fnc.Date.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@fnc.Client_name (@fnc.Id)</td>
                        <td>@fnc.TransmitterName</td>
                        <td>@fnc.ProcessorName</td>
                        <td>
                            @if (fnc.Status == "ouvert")
                            {
                                <span class="badge badge-primary">@fnc.Status</span>
                            }
                            else if (fnc.Status == "en_cours")
                            {
                                <span class="badge badge-warning">@fnc.Status</span>
                            }
                            else if (fnc.Status == "fermé")
                            {
                                <span class="badge badge-success">@fnc.Status</span>
                            }
                            else if (fnc.Status == "annulé")
                            {
                                <span class="badge badge-danger">@fnc.Status</span>
                            }
                            else if (fnc.Status == "En_attente")
                            {
                                <span class="badge badge-info">@fnc.Status</span>
                            }
                            else
                            {
                                <span class="badge badge-secondary">@fnc.Status</span>
                            }
                        </td>
                        <td>
                            @if (fnc.HasQrqc)
                            {
                                <span class="badge badge-success">Oui</span>
                            }
                            else
                            {
                                <span class="badge badge-secondary">Non</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a asp-action="Details" asp-route-id="@fnc.Id" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a asp-action="Edit" asp-route-id="@fnc.Id" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                                @if (User.IsInRole("Admin"))
                                {
                                    <form asp-action="Delete" asp-route-id="@fnc.Id" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" 
                                                onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette FNC?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-sm btn-danger" onclick="alert('Seul l\'administrateur peut supprimer une FNC');">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="8" class="text-center">Aucune FNC trouvée</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('input[name="status"]').forEach(function (el) {
                el.addEventListener('change', function () {
                    document.getElementById('filterForm').submit();
                });
            });
        });
    </script>
}
